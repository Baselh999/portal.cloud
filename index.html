<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙƒØ§Ù…ÙŠØ±Ø§ + Ø±ÙØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ GitHub Pages</title>
    <style>
        body {font-family: Arial; text-align: center; background:#f0f0f0; padding:20px;}
        video {width:90%; max-width:800px; border:5px solid #333; border-radius:15px;}
        .msg {font-size:22px; margin:20px;}
        .error {color:red; font-weight:bold;}
        #photos img {width:300px; border:4px solid #333; border-radius:10px; margin:10px; box-shadow:0 4px 8px rgba(0,0,0,0.2);}
        #counter {font-size:30px; color:#0066cc; margin:20px;}
        .uploaded {color:green; font-weight:bold;}
    </style>
</head>
<body>
    <h1>ÙƒØ§Ù…ÙŠØ±Ø§ + Ø±ÙØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ GitHub Pages</h1>
    <p class="msg">Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ØŒ Ø«Ù… ÙƒÙ„ Ø´ÙŠØ¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ!</p>
    
    <!-- Ø¶Ø¹ Ù‡Ù†Ø§ Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø³) -->
    <script>
        // <<<<<<<< ØºÙŠÙ‘Ø± Ø§Ù„Ø«Ù„Ø§Ø« Ù…ØªØºÙŠÙ‘Ø±Ø§Øª Ø¯ÙˆÙ„ Ø¨Ø³ >>>>>>>>
        const GITHUB_TOKEN = "ghp_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"; // Ø­Ø· Ø§Ù„ØªÙˆÙƒÙ† Ù‡Ù†Ø§
        const REPO = "username/my-camera-photos"; // ØºÙŠÙ‘Ø± username Ø¥Ù„Ù‰ Ø§Ø³Ù…ÙƒØŒ Ùˆmy-camera-photos Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        const BRANCH = "main"; // Ø¹Ø§Ø¯Ø©Ù‹ main
        // <<<<<<<< Ø®Ù„ØµØª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ >>>>>>>>

        const API_URL = `https://api.github.com/repos/${REPO}/contents/`;
    </script>

    <video id="video" autoplay playsinline muted></video>
    <div id="counter">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø¹Ø¯: <span id="sec">3</span> Ø«ÙˆØ§Ù†Ù</div>
    <p class="msg" id="status"></p>

    <h2>Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© Ø¹Ù„Ù‰ GitHub Pages</h2>
    <div id="photos"></div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        (async () => {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const photosDiv = document.getElementById('photos');
            const status = document.getElementById('status');
            const counterSec = document.getElementById('sec');

            let countdown = 3;

            // Ø¯Ø§Ù„Ø© Ø±ÙØ¹ Ù…Ù„Ù Ø¥Ù„Ù‰ GitHub
            const uploadToGitHub = async (blob, filename) => {
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                return new Promise((resolve) => {
                    reader.onloadend = async () => {
                        const base64 = reader.result.split(',')[1];
                        const path = filename;

                        try {
                            // Ø¬Ù„Ø¨ SHA Ø¥Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯ (Ù„Ù„ØªØ­Ø¯ÙŠØ«)
                            let sha = null;
                            try {
                                const existing = await fetch(API_URL + path, {
                                    headers: { Authorization: `token ${GITHUB_TOKEN}` }
                                });
                                if (existing.ok) {
                                    const data = await existing.json();
                                    sha = data.sha;
                                }
                            } catch (e) {}

                            const response = await fetch(API_URL + path, {
                                method: 'PUT',
                                headers: {
                                    Authorization: `token ${GITHUB_TOKEN}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    message: `Upload ${filename} via camera`,
                                    content: base64,
                                    branch: BRANCH,
                                    sha: sha
                                })
                            });

                            if (response.ok) {
                                const data = await response.json();
                                const rawUrl = data.content.download_url || `https://raw.githubusercontent.com/${REPO}/${BRANCH}/${filename}`;
                                resolve(rawUrl);
                            } else {
                                throw new Error("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹");
                            }
                        } catch (err) {
                            console.error(err);
                            resolve(null);
                        }
                    };
                });
            };

            try {
                status.textContent = "Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†...";
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" } 
                });
                video.srcObject = stream;
                status.innerHTML = "Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„! Ø³ØªØ¨Ø¯Ø£ Ø§Ù„Ø±ÙØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ GitHub...";
                status.style.color = "green";

                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    // Ø±ÙØ¹ ØµÙˆØ±Ø© ÙƒÙ„ 3 Ø«ÙˆØ§Ù†Ù
                    const takePhoto = async () => {
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob(async (blob) => {
                            const filename = "photo_" + Date.now() + ".jpg";
                            const url = await uploadToGitHub(blob, filename);
                            if (url) {
                                const img = document.createElement('img');
                                img.src = url + "?t=" + Date.now(); // Ø¹Ø´Ø§Ù† ÙŠØ­Ø¯Ù‘Ø« Ø§Ù„ÙƒØ§Ø´
                                img.title = "Ù…Ø±ÙÙˆØ¹Ø©: " + new Date().toLocaleTimeString('ar-EG');
                                photosDiv.prepend(img);
                            } else {
                                status.innerHTML += "<br>ÙØ´Ù„ Ø±ÙØ¹ ØµÙˆØ±Ø©";
                            }
                        }, 'image/jpeg', 0.9);

                        countdown = 3;
                        counterSec.textContent = countdown;
                    };

                    setInterval(() => {
                        countdown--;
                        counterSec.textContent = countdown;
                        if (countdown <= 0) takePhoto();
                    }, 1000);

                    setTimeout(takePhoto, 3000);
                };

            } catch (err) {
                status.textContent = "ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ğŸ˜”";
                status.classList.add("error");
                console.error(err);
            }

            window.addEventListener('beforeunload', () => {
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(t => t.stop());
                }
            });
        })();
    </script>
</body>
</html>
